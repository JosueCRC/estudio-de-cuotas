<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Cuotas XML - Versión Full Reporte</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.27/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --sidebar-width: 320px; --header-height: 70px; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, sans-serif; overflow-x: hidden; }
        .top-navbar { height: var(--header-height); background: white; display: flex; align-items: center; padding: 0 25px; border-bottom: 1px solid #ddd; position: fixed; top: 0; width: 100%; z-index: 1040; }
        .sidebar { width: var(--sidebar-width); position: fixed; top: var(--header-height); left: 0; bottom: 0; background: white; border-right: 1px solid #ddd; padding: 20px; z-index: 1030; overflow-y: auto; }
        .main-content { margin-left: var(--sidebar-width); margin-top: var(--header-height); padding: 25px; }
        .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #outputTable { width: 100%; border-collapse: collapse; table-layout: fixed !important; }
        #outputTable thead th { position: sticky; top: 70px; background: #343a40 !important; color: white; z-index: 1000; padding: 12px 8px; font-size: 0.8rem; }
        .w-cod { width: 135px; } .w-desc { width: auto; } .w-num { width: 85px; }
        #outputTable td { border-bottom: 1px solid #eee; padding: 10px 8px; font-size: 0.82rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .row-link { cursor: pointer; } .row-link:hover { background-color: #f8fbff !important; }
        .group-header td { position: sticky; top: 112px; background: #e9ecef !important; font-weight: bold; z-index: 900; color: #495057; border-left: 5px solid #007bff; }
        .low-consumption { color: #dc3545; font-weight: bold; }
        .status-warning { color: #fd7e14; font-weight: bold; }
        .main-progress-container { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
        
        /* BARRA DE PROGRESO CORREGIDA */
        .progress { height: 28px; border-radius: 5px; font-weight: bold; font-size: 0.85rem; }
        .progress-bar { 
            transition: width 0.6s ease; 
            line-height: 28px; 
            color: white; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .bg-warning { color: #212529 !important; text-shadow: none !important; } /* Texto oscuro para el amarillo */

        .stat-card-main { background: white; flex: 1; padding: 15px; border-radius: 8px; text-align: center; border-top: 5px solid #ddd; cursor: pointer; transition: transform 0.2s; }
        .stat-card-main:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .justificacion-box { background: #fff; border: 1px dashed #007bff; padding: 18px; font-size: 0.9rem; color: #333; line-height: 1.6; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; }
        .attention-panel { background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #ffccd5; }
        .attention-list { max-height: 200px; overflow-y: auto; }
        
        /* Estilos adicionales para el modal */
        .modal-stat-card { background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center; }
        .modal-stat-card h6 { font-size: 0.7rem; color: #6c757d; margin-bottom: 5px; text-transform: uppercase; }
        .modal-stat-card h4 { margin-bottom: 0; font-weight: bold; }


        /* Contenedor de carga estilizado */
.upload-group {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
    transition: all 0.3s;
    position: relative;
    cursor: pointer;
}

.upload-group:hover {
    border-color: #007bff;
    background: #eef6ff;
}

.upload-group label {
    display: block;
    margin-bottom: 0;
    cursor: pointer;
    font-size: 0.75rem;
    color: #495057;
    font-weight: 600;
}

/* Ocultamos el input real pero mantenemos su funcionalidad */
.upload-group input[type="file"] {
    font-size: 0.7rem;
    width: 100%;
}
/* Esto hará que tus inputs de archivo se vean como cajas de clic */
input[type="file"] {
    background: #f8f9fa;
    border: 1px solid #ddd;
    padding: 5px;
    border-radius: 4px;
    width: 100%;
    cursor: pointer;
}
input[type="file"]:hover {
    background: #e9ecef;
    border-color: #007bff;
}
    </style>
</head>
<body>

<div class="modal fade" id="gestionModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-file-signature"></i> Análisis Técnico de Gestión</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="top-navbar">
    <h4 class="mb-0">Analizador de Cuotas XML <img src="https://i.postimg.cc/x846QM5r/iconmonstr-flower-4-240.png" width="22"></h4>
    

    <div class="ml-auto">
        <button class="btn btn-danger btn-sm shadow-sm" onclick="exportarInformePDF()"><i class="fas fa-file-signature mr-2"></i> <b>Generar Informe</b></button>

        <button class="btn btn-success btn-sm" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Exportar Reporte PDF</button>
    </div>
</div>

<div class="sidebar">
    <h6><i class="fas fa-filter"></i> Filtros de Control</h6>
    <input type="text" id="searchInput" class="form-control mb-2" placeholder="Buscar producto..." onkeyup="searchTable()">
    <select id="filterSelect" class="form-control mb-4" onchange="searchTable()">
        <option value="all">Ver Todos</option>
        <option value="red">Excesos (Crítico)</option>
        <option value="orange">Alertas (Riesgo)</option>
    </select>
    <hr>
    <h6><i class="fas fa-upload"></i> Carga de XML</h6>
    <div class="upload-group">
        <label><i class="fas fa-file-code text-primary"></i> Archivo Cuotas (F0)</label>
        <input type="file" id="f0" class="form-control-file">
    </div>
    <div class="upload-group">
        <label><i class="fas fa-history text-info"></i> Consumo Mes 1 (F1)</label>
        <input type="file" id="f1" class="form-control-file">
    </div>

    <div class="upload-group">
        <label><i class="fas fa-history text-info"></i> Consumo Mes 2 (F2)</label>
        <input type="file" id="f2" class="form-control-file">
    </div>

    <div class="upload-group">
        <label><i class="fas fa-history text-info"></i> Consumo Mes 3 (F3)</label>
        <input type="file" id="f3" class="form-control-file">
    </div>
    <button class="btn btn-primary btn-block" onclick="analyzeFiles()"><b>PROCESAR ANALISIS</b></button>
     <hr>
<div >
    <div class="bg-white p-2 border rounded mb-3 d-flex align-items-center shadow-sm">
    <span class="small font-weight-bold text-muted mr-3">ORDENAR POR:</span>
    
    <button class="btn btn-outline-info btn-sm mr-2" 
            onclick="ordenarPorCriterio('medio')" 
            title="Dígitos Medios (-XX-)">
        <i class="fas fa-arrows-alt-h"></i>
    </button>

    <button class="btn btn-outline-info btn-sm" 
            onclick="ordenarPorCriterio('final')" 
            title="Últimos 4 Dígitos">
        <i class="fas fa-sort-numeric-down"></i>
    </button>
</div>
</div>

    
</div>

<div class="main-content">
    
    <div class="main-progress-container">
        <div class="d-flex justify-content-between mb-2 small font-weight-bold text-muted">
            <span>DISTRIBUCIÓN DEL ESTADO DE INVENTARIO</span>
            <span id="labelTotalItems">0 ítems totales</span>
        </div>
        <div class="progress shadow-sm">
            <div id="barExceso" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
            <div id="barAlerta" class="progress-bar bg-warning text-dark" role="progressbar" style="width: 0%"></div>
            <div id="barNormal" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
        </div>
    </div>

    <div class="d-flex mb-4" style="gap:15px">
        <div class="stat-card-main" style="border-top-color: #dc3545" onclick="aplicarFiltroRapido('red')">
            <h6>Excesos</h6><span id="resumenExceso" class="h4 text-danger">0</span>
        </div>
        <div class="stat-card-main" style="border-top-color: #fd7e14" onclick="aplicarFiltroRapido('orange')">
            <h6>Alertas</h6><span id="resumenAlerta" class="h4 text-warning">0</span>
        </div>
        <div class="stat-card-main" style="border-top-color: #6f42c1">
            <h6>% Atención</h6><span id="porcentajeAtencion" class="h4" style="color: #6f42c1">0%</span>
        </div>
        <div class="stat-card-main" style="border-top-color: #28a745" onclick="aplicarFiltroRapido('all')">
            <h6>Total Ítems</h6><span id="totalLineas" class="h4 text-success">0</span>
        </div>
    </div>

    <div class="attention-panel shadow-sm" id="panelAtencion" style="display:none;">
        <h6 class="text-danger border-bottom pb-2"><i class="fas fa-exclamation-triangle"></i> PRODUCTOS QUE REQUIEREN ACCIÓN INMEDIATA (TOP 10)</h6>
        <div class="attention-list" id="listaAtencion"></div>
    </div>

    <div class="table-container">
        <table class="table table-hover table-sm mb-0" id="outputTable">
            <thead>
                <tr>
                    <th class="w-cod">Código</th>
                    <th class="w-desc">Descripción </th>
                    <th class="w-num text-right">Cuota</th>
                    <th class="w-num text-right">M1</th>
                    <th class="w-num text-right">M2</th>
                    <th class="w-num text-right">M3</th>
                    <th class="w-num text-right">Prom.</th>
                    <th class="w-num text-right" style="background:#2c3e50 !important; color:white">Nec. 1.5</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<footer class="fixed-bottom bg-white border-top p-2 text-muted shadow-lg" style="margin-left: var(--sidebar-width); z-index: 1050;">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-6">
                <small><strong>Analizador de Cuotas</strong> &copy; 2026 | Desarrollado por <span class="text-primary">Josue Gonzalez Barrios</span></small>
            </div>
            <div class="col-md-6 text-right">
                <span class="badge badge-pill badge-dark px-3">V 2.0</span>
                <small class="ml-2 font-italic">Optimizado para Gestión de Inventarios</small>
            </div>
        </div>
    </div>
</footer>
<script>
    let globalData = {};

    function aplicarFiltroRapido(v) { document.getElementById('filterSelect').value = v; searchTable(); }

    function analyzeFiles() {
        const files = [document.getElementById('f0').files[0], document.getElementById('f1').files[0], document.getElementById('f2').files[0], document.getElementById('f3').files[0]];
        if (files.some(f => !f)) return alert("Cargue los 4 archivos.");
        const data = {}; let loaded = 0;

        files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
                xml.querySelectorAll("FormattedReportObjects").forEach(report => {
                    const code = report.querySelector("FormattedReportObject[FieldName*='CODIGO'] Value")?.textContent.trim() || "N/A";
                    const product = report.querySelector("FormattedReportObject[FieldName*='DSC_PRODUCTO'] Value")?.textContent.trim() || "N/A";
                    const unit = report.querySelector("FormattedReportObject[FieldName*='COD_UNIDAD_MEDIDA'] Value")?.textContent.trim() || "N/A";
                    
                    let valNode = (index === 0) ? report.querySelector("FormattedReportObject[FieldName*='CAN_CUOTA'] Value") : report.querySelector("FormattedReportObject[FieldName*='CAN_PRODUCTO'] Value");
                    const val = parseFloat(valNode?.textContent || "0");

                    if (!data[code]) data[code] = { product, unit, cuota: 0, m: [0,0,0] };
                    if (index === 0) data[code].cuota = val; else data[code].m[index-1] = val;
                    if (product !== "N/A") data[code].product = product;
                    if (unit !== "N/A") data[code].unit = unit;
                });
                if (++loaded === 4) { globalData = data; displayData(data); }
            };
            reader.readAsText(file);
        });
    }

    function displayData(data) {
        const tbody = document.querySelector('#outputTable tbody');
        const listaAt = document.getElementById('listaAtencion');
        tbody.innerHTML = ''; listaAt.innerHTML = '';
        let exc = 0, alr = 0, nor = 0;
        let criticos = [];

        // No ordenamos aquí para respetar el orden que viene de la función de botones
        const keysToUse = Object.keys(data);
        let lastPref = "";

        keysToUse.forEach(code => {
            const r = data[code], avg = (r.m.reduce((a,b) => a+b, 0)/3), nec = (avg*1.5).toFixed(2);
            const utilization = r.cuota > 0 ? (avg / r.cuota) : 0;
            const isExc = avg > r.cuota, isAlr = !isExc && (avg >= r.cuota*0.85);
            
            if(isExc) exc++; else if(isAlr) alr++; else nor++;
            if(utilization >= 0.85) criticos.push({code, product: r.product, util: utilization, status: isExc ? 'EXCESO':'ALERTA'});

            const currentPref = code.substring(0,3);
            if(currentPref !== lastPref) {
                const hRow = tbody.insertRow(); hRow.className = "group-header";
                hRow.innerHTML = `<td colspan="8"><i class="fas fa-boxes"></i> Familia: ${currentPref}</td>`;
                lastPref = currentPref;
            }
            const row = tbody.insertRow(); row.className = "row-link"; row.onclick = () => abrirGestion(code);
            row.innerHTML = `<td>${code}</td><td><b>${r.product}</b></td><td class="text-right">${r.cuota}</td><td class="text-right">${r.m[0]}</td><td class="text-right">${r.m[1]}</td><td class="text-right">${r.m[2]}</td><td class="text-right ${isExc?'low-consumption':(isAlr?'status-warning':'')}">${avg.toFixed(2)}</td><td class="text-right font-weight-bold text-primary">${nec}</td>`;
        });

        criticos.sort((a,b) => b.util - a.util);
        criticos.slice(0,10).forEach(i => {
            listaAt.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:0.85rem; padding:3px 0; border-bottom:1px solid #eee;">
                <span><b>${i.code}</b> - ${i.product} (${(i.util*100).toFixed(1)}%)</span>
                <span class="badge ${i.status==='EXCESO'?'badge-danger':'badge-warning'}">${i.status}</span>
            </div>`;
        });
        document.getElementById('panelAtencion').style.display = criticos.length > 0 ? 'block' : 'none';

        const total = keysToUse.length;
        const pExc = total > 0 ? ((exc / total) * 100).toFixed(1) : 0;
        const pAlr = total > 0 ? ((alr / total) * 100).toFixed(1) : 0;
        const pNor = total > 0 ? ((nor / total) * 100).toFixed(1) : 0;

        const bE = document.getElementById("barExceso");
        bE.style.width = pExc + "%"; bE.innerText = pExc > 5 ? pExc + "%" : "";
        const bA = document.getElementById("barAlerta");
        bA.style.width = pAlr + "%"; bA.innerText = pAlr > 5 ? pAlr + "%" : "";
        const bN = document.getElementById("barNormal");
        bN.style.width = pNor + "%"; bN.innerText = pNor > 5 ? pNor + "%" : "";

        document.getElementById("resumenExceso").innerText = exc;
        document.getElementById("resumenAlerta").innerText = alr;
        document.getElementById("totalLineas").innerText = total;
        document.getElementById("porcentajeAtencion").innerText = total > 0 ? ((exc+alr)/total*100).toFixed(1)+"%" : "0%";
        document.getElementById("labelTotalItems").innerText = total + " ítems";
        searchTable();
    }

    function searchTable() {
        const txt = document.getElementById("searchInput").value.toLowerCase();
        const filt = document.getElementById("filterSelect").value;
        const rows = document.querySelectorAll("#outputTable tbody tr:not(.group-header)");
        document.querySelectorAll(".group-header").forEach(h => h.style.display = "none");
        rows.forEach(r => {
            const isRed = r.querySelector('.low-consumption'), isOr = r.querySelector('.status-warning');
            const matchTxt = r.innerText.toLowerCase().includes(txt);
            const matchFilt = (filt === "all") || (filt === "red" && isRed) || (filt === "orange" && isOr);
            if (matchTxt && matchFilt) {
                r.style.display = "";
                let p = r.previousElementSibling;
                while (p && !p.classList.contains('group-header')) p = p.previousElementSibling;
                if (p) p.style.display = "";
            } else r.style.display = "none";
        });
    }

    function abrirGestion(code) {
        const r = globalData[code]; 
        const avg = (r.m.reduce((a, b) => a + b, 0) / 3);
        const nec = (avg * 1.5).toFixed(2);
        const vigencia = avg > 0 ? (r.cuota / (avg / 30)).toFixed(0) : "∞";
        const porcentaje = ((avg / r.cuota) * 100).toFixed(1);

        const esAumento = avg > r.cuota;
        const colorClase = esAumento ? 'text-danger' : 'text-success';
        const tituloAccion = esAumento ? 'SOLICITUD DE AMPLIACIÓN DE CUOTA' : 'SOLICITUD DE REDUCCIÓN / AJUSTE DE CUOTA';
        const verboPropuesta = esAumento ? 'una ampliación' : 'un ajuste a la baja';
        const riesgoTexto = esAumento 
            ? `comprometiendo la continuidad del proceso por agotamiento temprano de la asignación.` 
            : `detectándose un excedente de cuota que permite optimizar la asignación según la demanda real.`;

        const justificante = `${tituloAccion}\n\n` +
            `PRODUCTO: ${r.product}\n` +
            `CÓDIGO DE IDENTIFICACIÓN: ${code}\n\n` +
            `I. ANTECEDENTES:\n` +
            `El producto cuenta con una cuota mensual de ${r.cuota} ${r.unit}. El análisis del último trimestre registra consumos de ${r.m[0]}, ${r.m[1]} y ${r.m[2]} unidades, resultando en un promedio mensual real de ${avg.toFixed(2)}.\n\n` +
            `II. ANÁLISIS OPERATIVO:\n` +
            `El consumo real representa el ${porcentaje}% de la cuota disponible. Bajo esta tendencia, la cobertura teórica es de ${vigencia} días mensuales, ${riesgoTexto}\n\n` +
            `III. PROPUESTA TÉCNICA:\n` +
            `Se requiere ${verboPropuesta} de la cuota basada en el factor de seguridad de 1.5 meses sobre el promedio real, estableciendo un nuevo requerimiento de ${nec} ${r.unit}.`;

        document.getElementById('modalBody').innerHTML = `
            <div class="report-section mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">PRODUCTO SELECCIONADO</h6>
                        <h4 class="text-primary mb-0">${r.product}</h4>
                        <small>ID: <b>${code}</b> | Unidad: <b>${r.unit}</b></small>
                    </div>
                    <div class="text-right">
                        <span class="badge ${esAumento ? 'badge-danger' : 'badge-success'} p-2" style="font-size:0.9rem">
                            <i class="fas ${esAumento ? 'fa-arrow-up' : 'fa-arrow-down'}"></i> ${esAumento ? 'AUMENTAR' : 'REDUCIR'}
                        </span>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-2 mb-2">
                    <div class="modal-stat-card">
                        <h6>CUOTA ACTUAL</h6>
                        <h4>${r.cuota}</h4>
                    </div>
                </div>
                <div class="col-md-2 mb-2">
                    <div class="modal-stat-card">
                        <h6>PROM. MENSUAL</h6>
                        <h4>${avg.toFixed(2)}</h4>
                    </div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="modal-stat-card border-primary" style="background: #f0f7ff;">
                        <h6>NUEVA NECESIDAD (1.5)</h6>
                        <h4 class="${colorClase}">${nec}</h4>
                    </div>
                </div>
                <div class="col-md-2 mb-2">
                    <div class="modal-stat-card">
                        <h6>VIGENCIA ACTUAL</h6>
                        <h4>${vigencia} d</h4>
                    </div>
                </div>
                <div class="col-md-3 mb-2">
                    <div class="modal-stat-card">
                        <h6>USO DE CUOTA</h6>
                        <h4>${porcentaje}%</h4>
                    </div>
                </div>
            </div>

            <div class="report-section bg-white border">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0"><i class="fas fa-file-alt"></i> JUSTIFICACIÓN TÉCNICA RECOMENDADA</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="copyJ()"><i class="fas fa-copy"></i> Copiar Texto</button>
                </div>
                <div class="justificacion-box" id="jtext">${justificante}</div>
            </div>`;
        $('#gestionModal').modal('show');
    }

    function copyJ() { navigator.clipboard.writeText(document.getElementById('jtext').innerText); alert("Copiado."); }

    function exportToPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF('landscape');
        const pdfRows = [];
        const rows = document.querySelectorAll("#outputTable tbody tr:not(.group-header)");
        rows.forEach(row => { if (row.style.display !== 'none') pdfRows.push(Array.from(row.cells).map(c => c.innerText)); });
        doc.text("Reporte de Análisis", 14, 15);
        doc.autoTable({ head: [['Código', 'Descripción', 'Cuota', 'M1', 'M2', 'M3', 'Prom.', 'Nec. 1.5']], body: pdfRows, startY: 20 });
        doc.save('Reporte.pdf');
    }

    function ordenarPorCriterio(criterio) {
        if (!globalData || Object.keys(globalData).length === 0) {
            alert("Primero procesa los archivos XML");
            return;
        }

        const entries = Object.entries(globalData);

        entries.sort((a, b) => {
            const codA = a[0];
            const codB = b[0];

            // 1. SIEMPRE ORDENAR PRIMERO POR FAMILIA (Primeros 3 dígitos)
            const famA = codA.substring(0, 3);
            const famB = codB.substring(0, 3);
            
            if (famA !== famB) {
                return famA.localeCompare(famB);
            }

            // 2. SI SON DE LA MISMA FAMILIA, APLICAR EL CRITERIO ELEGIDO
            if (criterio === 'medio') {
                const parteA = codA.split('-')[1] || "";
                const parteB = codB.split('-')[1] || "";
                return parteA.localeCompare(parteB);
            } else if (criterio === 'final') {
                const parteA = codA.slice(-4);
                const parteB = codB.slice(-4);
                return parteA.localeCompare(parteB);
            } else {
                return codA.localeCompare(codB);
            }
        });

        const dataOrdenada = {};
        entries.forEach(([key, value]) => {
            dataOrdenada[key] = value;
        });

        displayData(dataOrdenada);
    }

    
    function exportarInformePDF() {
    if (!globalData || Object.keys(globalData).length === 0) {
        alert("Sin datos para analizar."); return;
    }

    // 1. CAPTURA DE DATOS (IDs del index.html)
    const excesos = document.getElementById("resumenExceso")?.innerText || "0";
    const alertas = document.getElementById("resumenAlerta")?.innerText || "0";
    const incidenciaRaw = document.getElementById("porcentajeAtencion")?.innerText || "0%";
    const totalItems = document.getElementById("totalLineas")?.innerText || "0";
    
    const pCritico = document.getElementById("barExceso")?.innerText || "0%";
    const pRiesgo = document.getElementById("barAlerta")?.innerText || "0%";
    const pOptimo = document.getElementById("barNormal")?.innerText || "0%";
    
    const d = parseFloat(incidenciaRaw.replace('%', ''));

    // 2. CONFIGURACIÓN DEL PDF Y PALETA MODERNA (Año 2026)
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 20;
    const maxLineWidth = pageWidth - (margin * 2);

    // Colores modernos: Slate Dark para el encabezado, Crimson para el énfasis
    const colorHeader = [30, 41, 59]; // Slate 800 (Elegante y serio)
    const colorAccent = [225, 29, 72]; // Rose 600 (Para destacar necesidad sin ser "feo")

    // 3. ENCABEZADO MINIMALISTA
    doc.setFillColor(colorHeader[0], colorHeader[1], colorHeader[2]);
    doc.rect(0, 0, pageWidth, 50, 'F');

    // Logo con opacidad o filtro blanco (si aplica)
    const logoImg = document.querySelector('.top-navbar img');
    if (logoImg) { try { doc.addImage(logoImg, 'PNG', pageWidth - 35, 12, 20, 20); } catch(e){} }

    doc.setTextColor(255, 255, 255);
    doc.setFontSize(22); doc.setFont("helvetica", "bold");
    doc.text("DATA-REPORT 2026", margin, 22);
    
    doc.setFontSize(10); doc.setFont("helvetica", "normal");
    doc.setTextColor(200, 200, 200);
    doc.text("GESTIÓN DE SUMINISTROS BASADA EN DEMANDA POBLACIONAL", margin, 30);
    
    doc.setFillColor(colorAccent[0], colorAccent[1], colorAccent[2]);
    doc.rect(margin, 35, 40, 0.5, 'F'); // Línea de acento

    doc.setTextColor(255, 255, 255);
    doc.setFontSize(9);
    doc.text(`ID DE AUDITORÍA: ${Math.random().toString(36).substr(2, 9).toUpperCase()}`, margin, 42);
    doc.text(`FECHA: ${new Date().toLocaleDateString()} | ${new Date().toLocaleTimeString()}`, margin + 50, 42);

    // 4. BARRAS DE ESTADO REDISEÑADAS (Estilo "Pills")
    let currentY = 65;
    doc.setTextColor(30, 41, 59);
    doc.setFontSize(11); doc.setFont(undefined, 'bold');
    doc.text("MÉTRICAS DE COBERTURA ACTUAL", margin, currentY);

    currentY += 6;
    const barHeight = 8;
    const wCritico = (parseFloat(pCritico) || 0) / 100 * maxLineWidth;
    const wRiesgo = (parseFloat(pRiesgo) || 0) / 100 * maxLineWidth;
    const wOptimo = (parseFloat(pOptimo) || 0) / 100 * maxLineWidth;

    // Fondo gris suave para la barra total
    doc.setFillColor(241, 245, 249);
    doc.rect(margin, currentY, maxLineWidth, barHeight, 'F');

    doc.setFillColor(225, 29, 72); doc.rect(margin, currentY, wCritico, barHeight, 'F');
    doc.setFillColor(245, 158, 11); doc.rect(margin + wCritico, currentY, wRiesgo, barHeight, 'F');
    doc.setFillColor(16, 185, 129); doc.rect(margin + wCritico + wRiesgo, currentY, wOptimo, barHeight, 'F');

    // Etiquetas de porcentaje modernas
    doc.setFontSize(7); doc.setTextColor(71, 85, 105);
    doc.text(`DÉFICIT CRÍTICO: ${pCritico}`, margin, currentY + 12);
    doc.text(`BAJO MONITOREO: ${pRiesgo}`, margin + (maxLineWidth / 2), currentY + 12, { align: 'center' });
    doc.text(`DISPONIBILIDAD ÓPTIMA: ${pOptimo}`, pageWidth - margin, currentY + 12, { align: 'right' });

    // 5. HALLAZGOS TÉCNICOS
    currentY += 25;
    doc.setFontSize(11); doc.setTextColor(30, 41, 55); doc.setFont(undefined, 'bold');
    doc.text("I. EVALUACIÓN DE LA DEMANDA CLÍNICA REAL", margin, currentY);
    
    currentY += 8;
    doc.setFontSize(10); doc.setFont(undefined, 'normal');
    const hallazgos = [
        `• El análisis dinámico detecta que el ${incidenciaRaw} del inventario requiere expansión de techo presupuestario.`,
        `• Se identifican ${excesos} códigos con ruptura de cuota por afluencia de pacientes superior a la proyectada.`,
        `• La tendencia trimestral confirma que la asignación actual es insuficiente para cubrir el 100% de la demanda.`
    ];

    hallazgos.forEach(t => {
        let lines = doc.splitTextToSize(t, maxLineWidth);
        doc.text(lines, margin, currentY);
        currentY += (lines.length * 5) + 3;
    });

    // 6. PROPUESTAS AMPLIADAS (Solicitadas)
    currentY += 8;
    doc.setFontSize(11); doc.setFont(undefined, 'bold');
    doc.text("II. PLAN DE OPTIMIZACIÓN Y AMPLIACIÓN DE CUOTAS", margin, currentY);
    
    currentY += 8;
    doc.setFontSize(10); doc.setFont(undefined, 'normal');
    const propuestas = [
        `1. ELEVACIÓN DE TECHOS: Implementar de inmediato el factor de seguridad 1.5 sobre los ${excesos} ítems con sobreconsumo para garantizar stock operativo de 45 días.`,
        `2. ESCALABILIDAD DINÁMICA: Autorizar un margen de fluctuación del 20% adicional en los ${alertas} ítems identificados en 'Alerta', permitiendo una respuesta ágil ante picos de demanda poblacional.`,
        `3. RECALIBRACIÓN TRIMESTRAL: Establecer un ciclo de ajuste automático basado en el promedio móvil de los últimos 3 meses, eliminando la brecha entre cuota fija y consumo real variable.`
    ];

    propuestas.forEach(t => {
        let lines = doc.splitTextToSize(t, maxLineWidth);
        doc.text(lines, margin, currentY);
        currentY += (lines.length * 5) + 3;
    });

    // 7. FOOTER MODERNO CON DATOS DE AUTOR
    const footerY = 260;
    
    // Separador HR
    doc.setDrawColor(226, 232, 240);
    doc.line(margin, footerY - 10, pageWidth - margin, footerY - 10);

    // Fondo del Footer
    doc.setFillColor(30, 41, 59);
    doc.rect(0, footerY + 15, pageWidth, 22, 'F');

    // Firmas
    doc.setFontSize(8); doc.setFont(undefined, 'bold');
    doc.text("RESPONSABLE TÉCNICO", margin, footerY);
    doc.text("AUTORIZACIÓN DE DIRECCIÓN", pageWidth - margin, footerY, { align: 'right' });
    
    doc.setDrawColor(203, 213, 225);
    doc.line(margin, footerY + 5, margin + 45, footerY + 5);
    doc.line(pageWidth - margin - 45, footerY + 5, pageWidth - margin, footerY + 5);

    // Mis Datos y Año
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(6);
    doc.text("DISEÑO Y DESARROLLO POR JOSUE GONZALEZ BARRIOS", margin, footerY + 25);
    doc.setFontSize(5);
    doc.text("© 2026 | ANALIZADOR DE CUOTAS XML V2.0 | OPTIMIZADO PARA ENTORNOS DE SALUD", margin, footerY + 30);
    
    doc.text("PÁGINA 1 DE 1", pageWidth - margin, footerY + 28, { align: 'right' });

    doc.save(`Reporte_Estrategico_2026_${d}pct.pdf`);
}
</script>
</body>
</html>